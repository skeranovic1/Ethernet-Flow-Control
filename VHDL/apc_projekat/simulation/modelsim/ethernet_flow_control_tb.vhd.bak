library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity ethernet_flow_control_tb is
end entity;

architecture behavior of ethernet_flow_control_tb is

constant clock_period : time := 20 ns;

signal clock : std_logic := '0';
signal reset : std_logic := '0';

signal a_pause  : std_logic := '0';
signal a_p_time : std_logic_vector(15 downto 0) := (others => '0');
signal a_out_data  : std_logic_vector(7 downto 0);
signal a_out_valid : std_logic;
signal a_out_sop   : std_logic;
signal a_out_eop   : std_logic;

signal b_in_data  : std_logic_vector(7 downto 0) := (others => '0');
signal b_in_valid : std_logic := '0';
signal b_in_sop   : std_logic := '0';
signal b_in_eop   : std_logic := '0';
signal b_is_paused : std_logic;

begin

sender_A : entity work.ethernet_flow_control
port map (
    clock => clock,
    reset => reset,
    pause => a_pause,
    p_time => a_p_time,
    is_paused => open,
    in_data => (others => '0'),
    in_valid => '0',
    in_sop => '0',
    in_eop => '0',
    in_ready => open,
    out_data => a_out_data,
    out_valid => a_out_valid,
    out_sop => a_out_sop,
    out_eop => a_out_eop,
    out_ready => '1'
);

receiver_B : entity work.ethernet_flow_control
port map (
    clock => clock,
    reset => reset,
    pause => '0',
    p_time => (others => '0'),
    is_paused => b_is_paused,
    in_data => b_in_data,
    in_valid => b_in_valid,
    in_sop => b_in_sop,
    in_eop => b_in_eop,
    in_ready => open,
    out_data => open,
    out_valid => open,
    out_sop => open,
    out_eop => open,
    out_ready => '1'
);

b_in_data  <= a_out_data;
b_in_valid <= a_out_valid;
b_in_sop   <= a_out_sop;
b_in_eop   <= a_out_eop;

clock_process : process
begin
    clock <= '0';
    wait for clock_period/2;
    clock <= '1';
    wait for clock_period/2;
end process;

stim_proc : process
begin
    reset <= '1';
    wait for 3*clock_period;
    reset <= '0';

    wait for 5*clock_period;

    a_p_time <= x"0001";
    a_pause <= '1';
    wait for clock_period;
    a_pause <= '0';

    wait for 2000 ns;
    assert false severity failure;
end process;

end architecture;
